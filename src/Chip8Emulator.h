#ifndef CHIP8_EMULATOR_H
#define CHIP8_EMULATOR_H

#include <array>
#include <climits>
#include <cstdint>
#include <stack>

#include "Chip8System.h"
#include "Instruction.h"
#include "Chip8InstructionSet.h"

class Chip8Emulator
{
private:
  static constexpr std::array<InstructionSet::OpcodeFunction, 40> DECODE_TABLE
  {
    InstructionSet::opcode_high_nibble_low_byte(0x0, 0xE0, &Chip8System::cls),
    InstructionSet::opcode_high_nibble_low_byte(0x0, 0xEE, &Chip8System::ret),
    InstructionSet::opcode_high_nibble_low_byte(0x0, 0xFB, &Chip8System::sc_right),
    InstructionSet::opcode_high_nibble_low_byte(0x0, 0xFC, &Chip8System::sc_left),
    InstructionSet::opcode_high_nibble_low_byte(0x0, 0xFD, &Chip8System::exit),
    InstructionSet::opcode_high_nibble_low_byte(0x0, 0xFE, &Chip8System::lores),
    InstructionSet::opcode_high_nibble_low_byte(0x0, 0xFF, &Chip8System::hires),
    InstructionSet::opcode_high_nibble         (0x1,       &Chip8System::jmp),
    InstructionSet::opcode_high_nibble         (0x2,       &Chip8System::call),
    InstructionSet::opcode_high_nibble         (0x3,       &Chip8System::seq_vx_nn),
    InstructionSet::opcode_high_nibble         (0x4,       &Chip8System::sne_vx_nn),
    InstructionSet::opcode_high_nibble         (0x5,       &Chip8System::seq_vx_vy),
    InstructionSet::opcode_high_nibble         (0x6,       &Chip8System::mov_vx_nn),
    InstructionSet::opcode_high_nibble         (0x7,       &Chip8System::add_vx_nn),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x0,  &Chip8System::mov_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x1,  &Chip8System::or_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x2,  &Chip8System::and_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x3,  &Chip8System::xor_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x4,  &Chip8System::add_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x5,  &Chip8System::sub_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x6,  &Chip8System::shr_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0x7,  &Chip8System::rsb_vx_vy),
    InstructionSet::opcode_high_low_nibble     (0x8, 0xE,  &Chip8System::shl_vx_vy),
    InstructionSet::opcode_high_nibble         (0x9,       &Chip8System::sne_vx_vy),
    InstructionSet::opcode_high_nibble         (0xA,       &Chip8System::mov_i_nnn),
    InstructionSet::opcode_high_nibble         (0xB,       &Chip8System::jmp_vx_nnn),
    InstructionSet::opcode_high_nibble         (0xC,       &Chip8System::rnd_vx_nn),
    InstructionSet::opcode_high_nibble         (0xD,       &Chip8System::drw),
    InstructionSet::opcode_high_nibble_low_byte(0xE, 0x9E, &Chip8System::spr_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xE, 0xA1, &Chip8System::sup_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x07, &Chip8System::mov_vx_dt),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x0A, &Chip8System::wait_mov_vx_key),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x15, &Chip8System::mov_dt_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x18, &Chip8System::mov_st_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x1E, &Chip8System::add_i_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x29, &Chip8System::mov_i_font_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x30, &Chip8System::mov_i_bfont_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x33, &Chip8System::mov_i_bcd_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x55, &Chip8System::mov_i_vx),
    InstructionSet::opcode_high_nibble_low_byte(0xF, 0x65, &Chip8System::mov_vx_i),
  };

public:
  Chip8Emulator();
  
  Chip8System system{};

  void decodeInstruction(Instruction instruction);

  void loadRom(std::string_view filename);

  bool updateTimers() noexcept;

  [[nodiscard]] Instruction getCurrentInstruction() const;

  int cycle();
};

// normal font, size is 5 x F = 50
static constexpr std::array<std::uint8_t, 0x50> FONT {
  0xF0, 0x90, 0x90, 0x90, 0xF0,  // 0
  0x20, 0x60, 0x20, 0x20, 0x70,  // 1
  0xF0, 0x10, 0xF0, 0x80, 0xF0,  // 2
  0xF0, 0x10, 0xF0, 0x10, 0xF0,  // 3
  0x90, 0x90, 0xF0, 0x10, 0x10,  // 4
  0xF0, 0x80, 0xF0, 0x10, 0xF0,  // 5
  0xF0, 0x80, 0xF0, 0x90, 0xF0,  // 6
  0xF0, 0x10, 0x20, 0x40, 0x40,  // 7
  0xF0, 0x90, 0xF0, 0x90, 0xF0,  // 8
  0xF0, 0x90, 0xF0, 0x10, 0xF0,  // 9
  0xF0, 0x90, 0xF0, 0x90, 0x90,  // A
  0xE0, 0x90, 0xE0, 0x90, 0xE0,  // B
  0xF0, 0x80, 0x80, 0x80, 0xF0,  // C
  0xE0, 0x90, 0x90, 0x90, 0xE0,  // D
  0xF0, 0x80, 0xF0, 0x80, 0xF0,  // E
  0xF0, 0x80, 0xF0, 0x80, 0x80   // F
};

// big font, size is A x F = A0
static constexpr std::array<std::uint8_t, 0xA0> BIG_FONT {
  0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, // 0
  0x18, 0x78, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0xFF, // 1
  0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // 2
  0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 3
  0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, // 4
  0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 5
  0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 6
  0xFF, 0xFF, 0x03, 0x03, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x18, // 7
  0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 8
  0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 9
  0x7E, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, // A
  0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, // B
  0x3C, 0xFF, 0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC3, 0xFF, 0x3C, // C
  0xFC, 0xFE, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFE, 0xFC, // D
  0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // E
  0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0  // F
};

#endif
